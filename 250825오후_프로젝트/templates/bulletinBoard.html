<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²Œì‹œíŒ | ëƒ‰ì¥ê³ ë¥¼ ë¶€íƒí•´</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>

<body>

  {% include 'header.html' %}

  <div class="board-header-content">
    <div class="page-title hovered-element">ê²Œì‹œíŒ</div>
    <nav class="board-nav">
      <ul>
        <li><a href="#" id="list-link" style="display: none;">ê²Œì‹œê¸€ ëª©ë¡</a></li>
        <li><a href="#" id="write-link">ê²Œì‹œê¸€ ì‘ì„±</a></li>
      </ul>
    </nav>
  </div>

  <main class="board-container">
    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div id="list-page">
      <div class="posts-list" id="posts-container">
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ì‘ì„± -->
    <div id="write-page" style="display: none;">
      <div class="post-form-container">
        <form id="post-form">
          <div class="post-form-group">
            <label for="post-title" class="post-form-label">ì œëª©</label>
            <input type="text" id="post-title" class="post-form-control" required>
          </div>
          <div class="post-form-group">
  <label for="post-author" class="post-form-label">ì‘ì„±ì</label>
  <input type="text" id="post-author" class="post-form-control" 
         value="{{ nickname if nickname else '' }}" readonly>
</div>
          <div class="post-form-group">
            <label for="post-content" class="post-form-label">ë‚´ìš©</label>
            <textarea id="post-content" class="post-form-control" required></textarea>
          </div>
          <div class="post-form-actions">
            <button type="button" id="cancel-post" class="board-btn board-btn-danger">ì·¨ì†Œ</button>
            <button type="submit" class="board-btn board-btn-primary">ë“±ë¡</button>
          </div>
        </form>
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ìƒì„¸ -->
    <div id="detail-page" style="display: none;">
      <div class="post-detail" id="post-detail">
      </div>

      <div class="comments-section">
        <h2 class="comments-title">ëŒ“ê¸€</h2>
        <div class="comment-form">
          <form id="comment-form">
            <textarea id="comment-content" placeholder="ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”." class="post-form-control" required></textarea>
            <div class="post-form-actions">
              <button type="submit" class="board-btn board-btn-primary">ëŒ“ê¸€ ë“±ë¡</button>
            </div>
          </form>
          <div class="comment-list" id="comment-list">
          </div>
        </div>
      </div>
    </div>
  </main>

  {% include 'footer.html' %}

  <!-- ê³µí†µ JS -->
  <script src="{{ url_for('static', filename='base.js') }}"></script>

  <script>

let ME = null;

async function initMe() {
  try {
    const r = await fetch('/api/me');
    if (r.ok) {
      const me = await r.json();
      if (me.logged_in) ME = me; // {logged_in, userid, nickname}
    }
  } catch (e) {}
}

document.addEventListener('DOMContentLoaded', async () => {
  await initMe();
  showList();
});

  const listPage = document.getElementById('list-page');
  const writePage = document.getElementById('write-page');
  const detailPage = document.getElementById('detail-page');

  const postsContainer = document.getElementById('posts-container');
  const postForm = document.getElementById('post-form');
  const postTitleEl = document.getElementById('post-title');
  const postAuthorEl = document.getElementById('post-author'); // readonly, ì„œë²„ì—ì„œ ë¬´ì‹œ
  const postContentEl = document.getElementById('post-content');

  const writeLink = document.getElementById('write-link');
  const listLink = document.getElementById('list-link');
  const cancelBtn = document.getElementById('cancel-post');

  // ë„¤ë¹„ê²Œì´ì…˜
  writeLink.addEventListener('click', (e) => {
    e.preventDefault();
    listPage.style.display = 'none';
    detailPage.style.display = 'none';
    writePage.style.display = 'block';
    listLink.style.display = 'inline';
  });

  listLink.addEventListener('click', (e) => {
    e.preventDefault();
    showList();
  });

  cancelBtn.addEventListener('click', () => {
    showList();
  });

  // ëª©ë¡ ê·¸ë¦¬ê¸°
  async function loadPosts() {
    const res = await fetch('/api/posts');
    if (!res.ok) {
      alert('ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
      return;
    }
    const posts = await res.json();
    renderList(posts);
  }

function renderList(posts) {
  postsContainer.classList.add('post-grid');
  postsContainer.innerHTML = '';

  if (!posts.length) {
    postsContainer.innerHTML = '<div class="empty">ì²« ê¸€ì„ ì‘ì„±í•´ ë³´ì„¸ìš”!</div>';
    return;
  }

  posts.forEach(p => {
    const card = document.createElement('article');
    card.className = 'post-card';
    card.innerHTML = `
      <h3 class="post-title">${escapeHtml(p.title)}</h3>
      <div class="post-author">${escapeHtml(p.author)}</div>
      <p class="post-snippet">${escapeHtml(p.content)}</p>
      <div class="post-date">Posted on ${escapeHtml(p.date || '')}</div>
      <button class="board-btn board-btn-outline" data-id="${p.id}">ìì„¸íˆ</button>
    `;
    card.querySelector('[data-id]').addEventListener('click', () => showDetail(p.id));
    postsContainer.appendChild(card);
  });
}

  // ìƒì„¸ ë³´ê¸°
async function showDetail(id) {
  const res = await fetch(`/api/posts/${id}`);
  if (!res.ok) { alert('ê¸€ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'); return; }
  const p = await res.json();

  const owner = (ME && ME.userid === p.user_id); // ë³¸ì¸ ê¸€ ì—¬ë¶€ (MEëŠ” /api/me ê²°ê³¼)

  const detail = document.getElementById('post-detail');
  detail.innerHTML = `
    <h2 class="post-title">${escapeHtml(p.title)}</h2>
    <div class="post-meta">ì‘ì„±ì: ${escapeHtml(p.author)} Â· ${escapeHtml(p.date || '')}</div>
    <div id="post-content-area" class="post-content" style="white-space: pre-wrap;">${escapeHtml(p.content)}</div>
    ${owner ? `
      <div class="owner-actions" style="margin-top:12px;">
        <button class="board-btn board-btn-primary" id="edit-detail">ìˆ˜ì •</button>
        <button class="board-btn board-btn-danger" id="del-detail">ì‚­ì œ</button>
      </div>` : ''
    }
  `;

  // í™”ë©´ ì „í™˜
  listPage.style.display = 'none';
  writePage.style.display = 'none';
  detailPage.style.display = 'block';
  listLink.style.display = 'inline';

  // ğŸ”§ ì—¬ê¸°ì„œ ë¦¬ìŠ¤ë„ˆ ì—°ê²°(ë™ì  DOM ì´í›„!)
  if (owner) {
    const editBtn = document.getElementById('edit-detail');
    const delBtn  = document.getElementById('del-detail');

    editBtn?.addEventListener('click', () => openEditInline(p));
    delBtn?.addEventListener('click', () => deletePost(p.id, true));
  }
}
function openEditInline(p) {
  const detail = document.getElementById('post-detail');
  detail.innerHTML = `
    <h3 class="post-title">ê¸€ ìˆ˜ì •</h3>
    <div class="post-form-group">
      <label class="post-form-label">ì œëª©</label>
      <input type="text" id="edit-title" class="post-form-control" value="${escapeHtml(p.title)}">
    </div>
    <div class="post-form-group">
      <label class="post-form-label">ë‚´ìš©</label>
      <textarea id="edit-content" class="post-form-control" rows="8">${escapeHtml(p.content)}</textarea>
    </div>
    <div class="post-form-actions">
      <button class="board-btn board-btn-danger" id="edit-cancel">ì·¨ì†Œ</button>
      <button class="board-btn board-btn-primary" id="edit-save">ì €ì¥</button>
    </div>
  `;


  document.getElementById('edit-cancel').addEventListener('click', () => showDetail(p.id));

  // ì¸ë¼ì¸ ìˆ˜ì • ì €ì¥
document.getElementById('edit-save').addEventListener('click', async () => {
  const title = document.getElementById('edit-title').value.trim();
  const content = document.getElementById('edit-content').value.trim();
  if (!title || !content) { alert('ì œëª©/ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.'); return; }

  const r = await fetch(`/api/posts/${p.id}`, {
    method: 'PUT',
    headers: {'Content-Type':'application/json'},
    credentials: 'same-origin',     // í•„ìš” ì‹œ ì„¸ì…˜ ì¿ í‚¤ í¬í•¨
    body: JSON.stringify({ title, content })
  });

  if (r.ok) {                        // âœ… ì„±ê³µì´ë©´ ê·¸ëƒ¥ ìƒì„¸ ë‹¤ì‹œ ë¡œë“œ
    showDetail(p.id);
    return;
  }

  let err = {};
  try { err = await r.json(); } catch (_) {}
  alert(err.error || 'ìˆ˜ì • ì‹¤íŒ¨');    // ì‹¤íŒ¨ì¼ ë•Œë§Œ ì•Œë¦¼
});
}

async function deletePost(id, inDetail=false) {
  if (!confirm('ì •ë§ ì‚­ì œí• ê¹Œìš”?')) return;
  const r = await fetch(`/api/posts/${id}`, { method: 'DELETE' });
  if (!r.ok) {
    const err = await r.json().catch(()=>({}));
    alert(err.error || 'ì‚­ì œ ì‹¤íŒ¨'); return;
  }
  // ì‚­ì œ í›„ ëª©ë¡ìœ¼ë¡œ
  showList();
}

  // ê¸€ ì‘ì„±
  postForm.addEventListener('submit', async (e) => {
    e.preventDefault();

    const payload = {
      title: postTitleEl.value.trim(),
      content: postContentEl.value.trim()
      // authorëŠ” ì„œë²„ì—ì„œ ì„¸ì…˜ ê¸°ë°˜ìœ¼ë¡œ ìë™ ê²°ì •
    };

    if (!payload.title || !payload.content) {
      alert('ì œëª©ê³¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const res = await fetch('/api/posts', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (res.status === 401) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }
    if (!res.ok) {
      const err = await res.json().catch(() => ({}));
      alert(err.error || 'ë“±ë¡ ì‹¤íŒ¨');
      return;
    }

    const created = await res.json();
    // ì´ˆê¸°í™”
    postTitleEl.value = '';
    postContentEl.value = '';

    // ë°©ê¸ˆ ì“´ ê¸€ ìƒì„¸ë¡œ ì´ë™
    await showDetail(created.id);
  });

  function showList() {
    detailPage.style.display = 'none';
    writePage.style.display = 'none';
    listPage.style.display = 'block';
    listLink.style.display = 'none';
    loadPosts();
  }

  // XSS ë°©ì§€
  function escapeHtml(str) {
    return (str || '').replace(/[&<>"']/g, s => ({
      '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
    }[s]));
  }

  </script>
</body>

</html>